# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Deploy to Oracle Cloud VPS

# ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ê²ƒì¸ì§€ ì •ì˜
on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— pushë  ë•Œë§Œ ì‹¤í–‰

# ì‹¤í–‰ë  ì‘ì—…(job)ë“¤ì„ ì •ì˜
jobs:
  deploy:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½ (ìµœì‹  Ubuntu)
    runs-on: ubuntu-latest

    # ì‘ì—…ì˜ ë‹¨ê³„(step)ë“¤ì„ ì •ì˜
    steps:
      # 1. ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. SSHë¥¼ í†µí•´ VPSì— ì ‘ì†í•˜ì—¬ ë°°í¬ ëª…ë ¹ì–´ ì‹¤í–‰
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }} # GitHub Secretì—ì„œ IP ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
          username: ${{ secrets.VPS_USER }} # GitHub Secretì—ì„œ ì‚¬ìš©ì ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
          key: ${{ secrets.VPS_PRIVATE_KEY }} # GitHub Secretì—ì„œ SSH ê°œì¸í‚¤ ê°€ì ¸ì˜¤ê¸°
          script: |
            # NVM í™˜ê²½ ë³€ìˆ˜ë¥¼ ë¡œë“œí•˜ì—¬ npmê³¼ pm2ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            # --------------------------

              # VPSì—ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì‘ì„±
            cd ${{ secrets.VPS_PROJECT_PATH }} # Secretì— ì €ì¥ëœ í”„ë¡œì íŠ¸ ê²½ë¡œë¡œ ì´ë™

            echo "ğŸšš Pulling latest code from GitHub..."
            git pull origin main # ìµœì‹  ì½”ë“œë¥¼ pull

            # Node.js í”„ë¡œì íŠ¸ì˜ ê²½ìš° (í•„ìš”ì— ë”°ë¼ ìˆ˜ì •)
            echo "ğŸ“¦ Installing dependencies..."
            npm install

            echo "ğŸ”¨ Building application..."
            npm run build

            echo "ğŸš€ Starting application with PM2..."
            pm2 restart nearbybook || pm2 start dist/main.js --name nearbybook --watch

            echo "âœ… Deployment successful!"
